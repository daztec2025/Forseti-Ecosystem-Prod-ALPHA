# Azure DevOps CI/CD Pipeline for Forseti Web App
# Deploys to Azure Container Apps via Azure Container Registry

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - 'apps/web/**'
      - 'docker/web/**'
      - 'packages/**'

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Azure Container Registry
  dockerRegistryServiceConnection: 'ForsetiACRConnection'
  containerRegistry: 'forsetiregistry.azurecr.io'
  imageRepository: 'forseti-web'
  dockerfilePath: 'docker/web/Dockerfile'
  tag: '$(Build.BuildId)'

  # Azure Container Apps
  azureSubscription: 'Forseti-Azure-Connection'
  containerAppName: 'forseti-web'
  resourceGroup: 'Forseti-DEV'
  containerAppEnv: 'forseti-env'

  # API URL for the web app to connect to
  apiUrl: 'https://forseti-api.icyfield-da5f7469.uksouth.azurecontainerapps.io'

stages:
  - stage: Build
    displayName: 'Build and Push Image'
    jobs:
      - job: Build
        displayName: 'Build Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build and push to ACR'
            inputs:
              containerRegistry: '$(dockerRegistryServiceConnection)'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              Dockerfile: '$(dockerfilePath)'
              buildContext: '$(Build.SourcesDirectory)'
              arguments: '--build-arg NEXT_PUBLIC_API_URL=$(apiUrl)'
              tags: |
                $(tag)
                latest

  - stage: Deploy
    displayName: 'Deploy to Container Apps'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: Deploy
        displayName: 'Deploy Container App'
        environment: 'forseti-web-prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureCLI@2
                  displayName: 'Deploy to Container Apps'
                  inputs:
                    azureSubscription: '$(azureSubscription)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Update the container app with the new image
                      az containerapp update \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --image $(containerRegistry)/$(imageRepository):$(tag)

                      # Verify deployment
                      az containerapp show \
                        --name $(containerAppName) \
                        --resource-group $(resourceGroup) \
                        --query "properties.latestRevisionFqdn" \
                        --output tsv
